name: Security Audit

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.24.0
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '1'
        
    - name: Run Checkov security scan
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: .
        framework: terraform,kubernetes
        soft_fail: true
        output_format: cli
        compact: true
        quiet: true
        skip_check: CKV_K8S_31,CKV_K8S_38
        
    - name: Run TruffleHog secrets scan
      uses: trufflesecurity/trufflehog@v3.90.6
      with:
        path: ./
        extra_args: --debug --only-verified